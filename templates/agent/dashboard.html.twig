{% extends 'base.html.twig' %}
{% block stylesheets %}
    <link rel="stylesheet" href="{{asset('assets/css/jquery-te-1.4.0.css')}}" type="text/css"/>
    <link rel="stylesheet" href="{{ asset('build/agentstyle.css') }}" type="text/css"/>
{% endblock %}
{% block body %}


<div id="topDivider">
    <h2>Welcome {{app.user.firstName}}</h2>
</div>
<div id="content">
<nav id="sidebar">
    <ul class="list-group ">
         <a href="#"><li class="list-group-item-light"><i class="fas fa-home"></i>&nbsp;</i>Home</li></a>
         <a href="#"><li class="list-group-item-light"><i class="fas fa-book"></i>&nbsp;</i>Reporting</li></a>
         {% if app.user.isAdmin %}
         <a id="AdminSection" href="#"><li class="list-group-item-light">Admin</li></a>
         {% endif %}
         <a id="UnassignedTicketButton" href="#"><li class="list-group-item-light active"><i class="fas fa-home"></i>&nbsp;</i>Unassigned Tickets</li></a>
         <a id="myticketbutton" href="#"><li class="list-group-item-light"><i class="fas fa-ticket-alt"></i>&nbsp;</i>My Tickets</li></a>
     </ul>
</nav>
{% if app.user.isAdmin %}
{{ render(controller('App\\Controller\\AdminController::UserList')) }}
{% endif %}
{#    Assigned Tickets    #}
        <div id="assignedTickets">
            <h3>Assigned Tickets</h3>
            {% block assignedtickets %}
                {{ render(controller('App\\Controller\\AgentController::AssignedTicket')) }}
            {% endblock %}
        </div>
        <div id="UnassignedTickets">
            <h3>Unassigned Tickets</h3>
            <table class="table">
                <thead class="thead-dark">
                <th scope="col">Ticket Id</th>
                <th scope="col">Requester</th>
                <th scope="col">Submitted On</th>
                <th scope="col">Status</th>
                </thead>
                <tbody>
                 {% for ticket in UTickets %}
                     <tr>
                        <td>{{ticket.id}}</td>
                        <td>
                           {{ ticket.requester.firstName }}&nbsp;{{ticket.requester.lastName}}
                        </td>
                        <td>{{ticket.created_on|date('d-m-Y')}}</td>
                        <td>{{ticket.status}}</td>
                        <td><a data-ticketid="{{ticket.id}}" class="btn btn-info viewticket" href="#">View</a></td>
                     </tr>
                 {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="ticketInfo">

            {%block ticket %}{% endblock %}
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    <script src="{{ asset('assets/js/jquery-te-1.4.0.js')}}" type="text/javascript"></script>
    <!-- ToDo -->
    <!-- Move to external Js -->
    <script type="text/javascript">
        $(document).ready(function(){
            $('#ticketInfo').hide();
            $('#ticketupdate').hide();
            $('#assignedTickets').hide();
            $('#AdminTable').hide();

            $('#UnassignedTicketButton').click(function(e){
               e.preventDefault();
               $('#sidebar').find('li.active').removeClass('active');
                $('#UnassignedTicketButton').closest("li").addClass('active');
               $('#ticketInfo').hide();
               $('#ticketupdate').hide();
               $('#assignedTickets').hide();
               $('#AdminTable').hide();
               $('#UnassignedTickets').show();

            });
            $('#AdminSection').click(function(e){
              e.preventDefault();
              $('#sidebar').find('li.active').removeClass('active');
               $('#AdminSection').closest("li").addClass('active');
              $('#ticketInfo').hide();
              $('#ticketupdate').hide();
              $('#assignedTickets').hide();
              $('#UnassignedTickets').hide();
              $('#AdminTable').show();
            });

            $('.viewticket').click(function(e){
                e.preventDefault();
                jQuery.ajax({
                type:"POST",
                url:'{{ (path('fetchticket')) }}',
                dataType: "json",
                data: {
                    "id": $(this).data('ticketid')
                },
                success: function(data){
                  template = data;
                  $('#UnassignedTickets').hide();
                  $('#assignedTickets').hide();
                  $('div#ticketInfo').html(template);
                  $('#ticketInfo').show();
                  $('.fulleditor').jqte();
                  }
                });
            });
            //Update Ticket
            $(document).on('click','.updateTicket', function(e){
                e.preventDefault();
                console.log("Form Submitted");
                console.log($('#data_id').val());
                jQuery.ajax({
                   type:"POST",
                   url:'{{ (path('updateticket')) }}',
                   datatype: "json",
                   data: {
                      'id': $('#data_id').val(),
                      'title': $('#data_title').val(),
                      'assignee': $('#data_assignee').val(),
                      'requester': $('#data_requester').val(),
                      'status': $('#data_status').val(),
                      'priority' : $('#data_priority').val(),
                      'reply': $('.jqte_editor').html(),
                      'replytype' : $('#reply_responsetype').val(),
                      'userId': '{{app.user.id}}'
                    },
                    success: function(data){
                        $('#ticketform').prepend(data.html);

                    }
                });
            });
          $(document).on('click','#internal-response',function(e){
              e.preventDefault();
              console.log("Internal BTN Clicked");
              $(this).parent('span').parent('div').find('.jqte_editor').css('background', '#98fb98');
              $('#reply_responsetype').val('INTERNAL');
            });
            $(document).on('click','#public-response',function(e){
              e.preventDefault();
              console.log("Public BTN Clicked");
              $(this).parent('span').parent('div').find('.jqte_editor').css('background-color', '#FFF');
              $('#reply_responsetype').val('PUBLIC');
            });
            $('#myticketbutton').click(function(e){
                e.preventDefault();
                $('#sidebar').find('li.active').removeClass('active');
                $('#myticketbutton').closest("li").addClass('active');
                $('#UnassignedTickets').hide();
                $('#ticketInfo').hide();
                $('#AdminTable').hide();
                $('#assignedTickets').show();

                $('#ticketupdate').hide();
            });

            $(document).on('click','.viewuser', function(e){
                e.preventDefault();
                var id = $(this).data('userid');
                console.log(id);
                jQuery.ajax({
                   type:"POST",
                   url:'{{ (path('finduser')) }}',
                   datatype: "json",
                   data: {
                      'id': $(this).data('userid'),
                    },
                    success: function(data){
                        $('#userviewmodal .modal-body').html(data);
                        $('#userviewmodal').modal('show');
                    }
                });
                });
                //Response type settings

              });


    </script>

{% endblock %}
